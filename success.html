<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Autenticando...</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <h2>Autenticando...</h2>

  <script>
    const t = TrelloPowerUp.iframe();

    async function salvarTokens() {
      try {
        const res = await fetch('/api/oauth2callback' + window.location.search);
        
        // Verifique se a resposta é JSON
        const contentType = res.headers.get('Content-Type');
        let data;
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          const text = await res.text();
          throw new Error('Resposta não é JSON. Conteúdo: ' + text);
        }

        console.log('Dados retornados: ', data);

        if (data && data.tokens && data.tokens.access_token) {
          await t.set('member', 'shared', 'googleTokens', data.tokens);
          document.body.innerHTML = '<h3>Autenticação concluída com sucesso. Você pode fechar esta aba.</h3>';
        } else {
          throw new Error('Tokens não retornados.');
        }
      } catch (err) {
        console.error('Erro na autenticação: ', err);
        document.body.innerHTML = `<h3>Erro na autenticação: ${err.message}</h3>`;
      }
    }

    salvarTokens();
  </script>
</body>
</html>
