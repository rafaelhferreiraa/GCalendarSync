<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Autenticando...</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <h2>Autenticando...</h2>

  <script>
    const t = TrelloPowerUp.iframe();

    async function salvarTokens() {
      try {
        const res = await fetch('/api/oauth2callback' + window.location.search);
        const data = await res.json();

        console.log('Tokens recebidos:', data.tokens);  // Adicionando log para depuração

        if (data.tokens && data.tokens.access_token) {
          await t.set('member', 'shared', 'googleTokens', data.tokens);
          document.body.innerHTML = '<h3>Autenticação concluída com sucesso. Você pode fechar esta aba.</h3>';
        } else {
          throw new Error('Tokens não retornados.');
        }
      } catch (err) {
        console.error('Erro durante a autenticação:', err);
        document.body.innerHTML = '<h3>Erro na autenticação.</h3>';
      }
    }

    salvarTokens();
  </script>
</body>
</html>
